<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link href="../styles.css" rel="stylesheet">
    <title>aamakarenko.ru</title>
  </head>
  <body>
    <div id="header">
      <h2>aamakarenko.ru</h2>
    </div>
    <div id="nav">
      <ul>
        <li><a href="../index.html">Главная</a></li>
        <li><a href="server_setup.html">Настройка сервера Linux (Ubuntu)</a></li>
        <li><a href="drf_rest_api.html">Настройка Django для работы с REST API</a></li>
        <li><a href="django_jwt_auth.html">Настройка JWT аутентификации в Django</a></li>
      </ul>
    </div>
    <div id="article">
      <h2>Настройка проекта Django/PostgreSQL/DRF/SWAGGER</h2>
      <p>Виртуальное окружение</p>
      <div class="code-container">
<code>python -m venv venv
. venv/bin/activate
pip install --upgrade pip</code>
      </div>
      <p>Установка нужных пакетов в окружение и заморозка пакетов в requirements.txt</p>
      <div class="code-container">
<code>pip install django gunicorn psycopg2-binary djangorestframework drf-yasg django-cors-headers
pip freeze -l > requirements.txt</code>
      </div>
      <br>
      <div class="code-container">
<code>django-admin startproject project</code>
      </div>
      <p>Вынести настройки в отдельную папку settings в project. В отдельном файле database.py добавить</p>
      <div class="code-container">
<code>DATABASES = {
  'default': {
      'ENGINE': 'django.db.backends.postgresql',
      'NAME': environ.get('POSTGRES_NAME'),
      'USER': environ.get('POSTGRES_USER'),
      'PASSWORD': environ.get('POSTGRES_PASSWORD'),
      'HOST': 'db',
      'PORT': 5432,
  }
}</code>
      </div>
      <p>Переместить BASE_DIR на уровень выше, прописать корректные SECRET_KEY, DEBUG, ALLOWED_HOSTS</p>
      <div class="code-container">
<code>SECRET_KEY = os.environ.get('SECRET_KEY', default='key')
BASE_DIR = os.path.join(os.path.dirname(__file__), '..', '..', '..')
DEBUG = os.environ.get('DEBUG') == 'True'
ALLOWED_HOSTS = os.environ.get('ALLOWED_HOSTS', default='0.0.0.0').split(' ')</code>
      </div>
      <p>Создать Dockerfile</p>
      <div class="code-container">
<code>FROM python:3.13-slim
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE 1

RUN apt update \
    && apt upgrade \
    && apt install postgresql gcc python3-dev musl-dev -y
WORKDIR /project
COPY requirements.txt .
RUN pip install --upgrade pip
RUN pip install -r requirements.txt
COPY ./project /project</code>
      </div>
      <p>Создать docker-compose.yaml</p>
      <div class="code-container">
<code>services:
  app:
    container_name: app
    build: .
    command: gunicorn --bind 0.0.0.0:8000
      --log-level debug
      --reload
      --workers 4 project.wsgi:application
    volumes:
      - ./project:/project
      - ./volumes/media:/media
      - ./volumes/static:/static
    ports:
      - 8000:8000
    env_file:
      - ./.env.dev
    depends_on:
      - db
  db:
    container_name: database
    image: postgres:17-alpine
    env_file: .env.dev
    volumes:
      - ./volumes/db/data:/var/lib/postgresql/data</code>
      </div>
      <p>Создать файл .env.dev для переменных окружения</p>
      <div class="code-container">
<code>SECRET_KEY=key
DEBUG=False
ALLOWED_HOSTS=localhost 127.0.0.1

POSTGRES_NAME=postgres
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres</code>
      </div>
      <p>Запустить контейнеры, применить миграции, скопировать статику в контейнер</p>
      <div class="code-container">
<code>./manage.py migrate
./manage.py collectstatic</code>
      </div>
      <p>Добавить в urls.py статику</p>
      <div class="code-container">
<code>urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)
urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)</code>
      </div>
      <p>так же роут апи в urlpatterns</p>
      <div class="code-container">
<code>path('api/', include(('api.urls', 'api_v1')))</code>
      </div>
      <p>Прописать настройки статики и медиа файлов</p>
      <div class="code-container">
<code>STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'static')
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')</code>
      </div>
      <p>Для аппов создать отдельную директорию apps на уровне с project<br><br>
        Для апи создать отдельную директорию api на уровне project<br>
        В нем создать urls.py со следующим содержимым</p>
      <div class="code-container">
<code>from django.urls import include, path
from drf_yasg import openapi
from drf_yasg.views import get_schema_view
from rest_framework import permissions, routers

router = routers.DefaultRouter()

schema_view = get_schema_view(
    openapi.Info(
        title='BACKEND API',
        default_version='v1',
        description='Routes of BACKEND',
    ),
    public=True,
    permission_classes=(permissions.AllowAny,),
)

urlpatterns = [
    path('swagger(<str:format>.json|.yaml)/', schema_view.without_ui(), name='schema-json'),
    path('swagger/', schema_view.with_ui('swagger'), name='schema-swagger-ui'),
    path('redoc/', schema_view.with_ui('redoc'), name='schema-redoc'),
    path('', include((router.urls, 'api-root')), name='api-root'),
]</code>
      </div>
      <p>Прописать drf_yasg и rest_framework в INSTALLED_APPS. Свагер поднят и доступен по api/swagger/</p>
      <h3>Настройка CORS Headers</h3>
      <p>Пакет django-cors-headers уже был установлен</p>
      <p>Добавить 'corsheaders' в INSTALLED_APPS</p>
      <p>Добавить 'corsheaders.middleware.CorsMiddleware' в MIDDLEWARE</p>
      <p>Добавить настройки для CORS</p>
      <div class="code-container">
<code>CORS_ORIGIN_ALLOW_ALL = os.environ.get('CORS_ORIGIN_ALLOW_ALL', True)
CORS_ORIGIN_WHITELIST = os.environ.get('CORS_ORIGIN_WHITELIST', [])
CSRF_TRUSTED_ORIGINS = CORS_ORIGIN_WHITELIST
CORS_ALLOW_CREDENTIALS = True
CORS_ALLOW_HEADERS = (
    'accept',
    'accept-encoding',
    'authorization',
    'content-type',
    'dnt',
    'origin',
    'user-agent',
    'x-csrftoken',
    'x-requested-with',
    'access-control-allow-origin',
)</code>
      </div>
      <h3>Создание простого аппа для статей и апи</h3>
      <div class="code-container">
<code>python project/manage.py startapp article</code>
      </div>
      <p>В ArticleConfig прописать корректный путь "apps.article", прописать в INSTALLED_APPS<br>
        Удалить views.py и tests.py, написать простую модель статьи</p>
      <div class="code-container">
<code>from django.db import models

class Article(models.Model):
  created_at = models.DateTimeField(auto_now_add=True)
  title = models.CharField('Заголовок статьи', max_length=127)
  body = models.TextField('Тело статьи')

  class Meta:
    verbose_name = 'Статья'
    verbose_name_plural = 'Статьи'

# Далее создать в директории api директорию article, в ней файлы views.py и serializers.py

# views.py

from rest_framework.viewsets import ModelViewSet
from apps.article.models import Article
from .serializers import ArticleSerializer

class ArticleViewSet(ModelViewSet):
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer

# serializers.py

from rest_framework import serializers
from apps.article.models import Article

class ArticleSerializer(serializers.ModelSerializer):
    class Meta:
        model = Article
        fields = ('id', 'created_at', 'title', 'body')

# В urls.py в api зарегистрировать вьюсет

router.register('article', ArticleViewSet, 'article')</code>
      </div>
    </div>
    <div id="footer">
        <p>Copyright © aamakarenko.ru 2025</p>
    </div>
  </body>
</html>
